---
import { Image } from "astro:assets";
import SectionContainer from "../components/SectionContainer.astro";
import PageTitle from "../components/PageTitle.astro";
import Link from "../components/Link.astro";
import RootLayout from "./RootLayout.astro";
import FormattedDate from "../components/FormattedDate.astro";
import Tag from "../components/Tag.astro";
import ScrollTopAndComments from "../components/ScrollTopAndComments.astro";
import { getAuthor, getTags } from "../lib/local-data";

interface Props {
  post: any;
  next?: any;
  prev?: any;
}

const { post, next, prev } = Astro.props as Props;

const authorRefs = Array.isArray(post.authors) ? post.authors : [post.authors];

const authors = await Promise.all(
  authorRefs.map((ref) => {
    const slug = typeof ref === "string" ? ref : ref?.slug || ref?.id;
    if (!slug) {
      console.warn("⚠️ Invalid author ref:", ref);
      return null;
    }
    return getAuthor(slug);
  })
);

const filteredAuthors = authors.filter(Boolean);
const tags = await getTags(post.tags || []);
const content = post.content ? post.content : "";

export const prerender = true;
---

<RootLayout title={post.title} description={post.summary}>
  <SectionContainer>
    <ScrollTopAndComments />
    <article class="section-container animate-fade-in">
      <div class="max-w-4xl mx-auto">
        <!-- Article Header -->
        <header class="mb-10">
          <div class="mb-3">
            <time class="text-sm text-dark-text-muted font-mono">
              <FormattedDate date={post.date} />
            </time>
          </div>
          <h1 class="text-3xl md:text-4xl font-bold mb-5">
            {post.title}
          </h1>
          
          <!-- Authors -->
          <div class="flex flex-wrap gap-4 items-center">
            {filteredAuthors.map(({ slug, name, avatar, twitter }) => (
              <div class="flex items-center gap-3" key={slug}>
                {avatar && (
                  <Image 
                    src={avatar || "/placeholder.svg"} 
                    width={48} 
                    height={48} 
                    alt={name}
                    class="rounded-full border border-dark-border" 
                  />
                )}
                <div>
                  <div class="font-semibold text-white">{name}</div>
                  {twitter && (
                    <Link href={twitter} class="text-sm text-dark-text-secondary hover:text-[var(--text-primary)] transition-colors no-underline">
                      {twitter.replace("https://twitter.com/", "@")}
                    </Link>
                  )}
                </div>
              </div>
            ))}
          </div>
        </header>

        <!-- Article Content -->
        <div class="prose prose-invert max-w-none mb-12">
          {post.Component && <post.Component />}
        </div>

        <!-- Footer -->
        <footer class="border-t border-dark-border pt-6 space-y-6">
          {tags.length > 0 && (
            <div>
              <h2 class="text-sm font-medium text-dark-text-muted mb-2">Tags</h2>
              <div class="flex flex-wrap gap-1.5">
                {tags.map((tag) => (
                  <Tag slug={tag.slug} />
                ))}
              </div>
            </div>
          )}

          {(next || prev) && (
            <nav class="grid md:grid-cols-2 gap-4">
              {prev && (
                <div class="py-3 border-b border-[var(--dark-border)] md:border-b-0">
                  <div class="text-xs text-dark-text-muted mb-1">Previous</div>
                  <Link href={`/blog/${prev.id}`} class="font-medium hover:text-[var(--text-primary)] transition-colors no-underline">
                    {prev.title}
                  </Link>
                </div>
              )}
              {next && (
                <div class="py-3 text-right">
                  <div class="text-xs text-dark-text-muted mb-1">Next</div>
                  <Link href={`/blog/${next.id}`} class="font-medium hover:text-[var(--text-primary)] transition-colors no-underline">
                    {next.title}
                  </Link>
                </div>
              )}
            </nav>
          )}

          <div class="text-center pt-3">
            <Link href="/blog" class="modern-button-primary modern-button no-underline" aria-label="Back to the blog">
              Back to Blog
            </Link>
          </div>
        </footer>
      </div>
    </article>
  </SectionContainer>
</RootLayout>
